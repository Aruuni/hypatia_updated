# Tracking: link net-device utilization

This tracks the utilization of point-to-point network devices (part of a 'link').

It encompasses the following files:

* **NetDeviceUtilizationTracker:** `model/core/net-device-utilization-tracker.cc/h`
  
  Link net-device utilization tracker
  
* **PtopLinkNetDeviceUtilizationTracking:**  `helper/core/ptop-link-net-device-utilization-tracking.cc/h`
  
  Helper to install the utilization trackers on the network devices in a topology.

You can use the application(s) separately, or make use of the helper 
which requires a topology (which is recommended).


## Getting started: using helper

1. Add the following to the `config_ns3.properties` in your run folder
   (for tracking utilization at a 100ms granularity):

   ```
   enable_link_net_device_utilization_tracking=true
   link_net_device_utilization_tracking_interval_ns=100000000
   link_net_device_utilization_tracking_enable_for_links=all
   ```

2. In your code, import the helper:

   ```c++
   #include "ns3/ptop-link-net-device-utilization-tracking.h"
   ```
   
3. Before the start of the simulation run, in your code add:

   ```c++
   // Install link net-device utilization trackers
   PtopLinkNetDeviceUtilizationTracking netDeviceUtilizationTracking = PtopLinkNetDeviceUtilizationTracking(basicSimulation, topology);
   ```

4. After the run, in your code add:

   ```c++
   // Write link net-device utilization result
   netDeviceUtilizationTracking.WriteResults();
   ```
   
5. After the run, you should have the link net-device utilization log files in the `logs_ns3` of your run folder.


## Getting started: directly using tracker

1. In your code, import the tracker:

   ```c++
   #include "ns3/net-device-utilization-tracker.h"
   ```
   
2. Before the start of the simulation run, in your code add:

   ```c++
   Ptr<PointToPointNetDevice> networkDevice = ... // Get the network device from somewhere
   int64_t utilization_interval_ns = 100000000; // 100ms
   Ptr<NetDeviceUtilizationTracker> tracker = CreateObject<NetDeviceUtilizationTracker>(networkDevice, utilization_interval_ns);
   // ... store the tracker to keep it alive and later retrieve its results
   ```

3. After the run, in your code add:

   ```c++
   const std::vector<std::tuple<int64_t, int64_t, int64_t>> intervals = tracker->FinalizeUtilization();
   for (size_t j = 0; j < intervals.size(); j++) {
       int64_t interval_start_ns = std::get<0>(intervals[j]);
       int64_t interval_end_ns = std::get<1>(intervals[j]);
       int64_t interval_busy_time_ns = std::get<2>(intervals[j]);
       double interval_utilization = ((double) interval_busy_time_ns) / (double) (interval_end_ns - interval_start_ns);
       // ... then do something with it, print it
   }
   ```


## Helper configuration

You MUST set the following key in `config_ns3.properties` for utilization tracking to be enabled:

* `enable_link_net_device_utilization_tracking` :
  - **Description:** true iff link net-device utilization tracking on links should be enabled 
  - **Value type:** boolean: `true` or `false`
* `link_net_device_utilization_tracking_interval_ns`
  - **Description:** the aggregation interval, this effectively determines 
  the granularity of the utilization results. Setting it too low will cause a lot of
  overhead, setting it too high will make the results less fine.
  - **Value type:** positive integer (ns)

The following CAN be set:

* `link_net_device_utilization_tracking_enable_for_links`
  - **Description:** select which links utilization tracking should be enabled
  - **Value types:**
    - `all` to enable on all links (default)
    - Set of links (directed edges) `set(a->b, ...)` if only on a particular subset of links


## Helper log files (output)

There are four log files generated by the run in the `logs_ns3` folder within the run folder:

#### `link_net_device_utilization.csv`

- **Description:** CSV formatted utilization at the interval level.  
- **Distributed filename:** `system_[X]_link_net_device_utilization.csv`
- **Format:** 
  ```
  [from node id],[to node id],[interval start (ns since epoch)],[interval end (ns since epoch)],[time busy in this interval (ns)]
  ```

#### `link_net_device_utilization_compressed.csv`

- **Description:** CSV formatted utilization at the interval level, but adjacent intervals with the same 
  utilization (approximately) are joined together. Particularly handy for plotting. 
- **Distributed filename:** `system_[X]_link_net_device_utilization_compressed.csv`
- **Format:** 
  ```
  [from node id],[to node id],[interval start (ns since epoch)],[interval end (ns since epoch)],[time busy in this interval (ns)]
  ```

#### `link_net_device_utilization_compressed.txt`

- **Description:** human readable table showing utilization at the interval level, 
  but compressing together the adjacent intervals which have the same utilization (approximately).
- **Distributed filename:** `system_[X]_link_net_device_utilization_compressed.txt`
- **Format:** none. Use the CSV equivalent for processing logs automatically.

#### `link_net_device_utilization_summary.txt`

- **Description:** human readable table of the mean utilization of each link.
- **Distributed filename:** `system_[X]_link_net_device_utilization_summary.txt`
- **Format:** none. Use the CSV equivalents for processing logs automatically.
